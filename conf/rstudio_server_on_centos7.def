Bootstrap: docker
From: centos:centos7

%help
	see https://github.com/nesi/rstudio_on_nesi

%files
	# list of RPM packages to install to mimic a Mahuika node
	wbn_rpms.txt

	# helper script for password authentication with RStudio server
	pam-helper /usr/bin/pam-helper

	# customise RStudio server login page to allow auto-filling
	login.html /etc/rstudio/login.html

%post
	yum -y upgrade
	yum -y install epel-release

	# install packages from Mahuika node list (excluding slurm) without version numbers
	yum -y install $(grep -v slurm wbn_rpms.txt | sed -r "s/-[0-9].*$//g" | sort | uniq)

	# TODO packages not found on wbn node, are they really needed?
	# lua-devel-5.1.4-15.el7.x86_64
	# tcl-devel-8.5.13-8.el7.x86_64
	# lua-bitop-1.0.2-3.el7.x86_64

	# install TeX Live distribution, for Rmarkdown
	yum -y install texlive \
	texlive-iftex \
	texlive-framed \
	texlive-latex \
	texlive-collection-latex \
	texlive-collection-latexrecommended

	# install nginx to fix urls returned by RStudio
	yum -y install nginx

	# install RStudio server
	wget https://download2.rstudio.org/server/centos7/x86_64/rstudio-server-rhel-2022.07.1-554-x86_64.rpm
	yum -y install rstudio-server-rhel-2022.07.1-554-x86_64.rpm

	# RStudio server configuration
	echo "www-address=127.0.0.1" >> /etc/rstudio/rserver.conf
	echo "www-frame-origin=same" >> /etc/rstudio/rserver.conf

	mkdir -p /var/lib/rstudio-server
	chmod -R 777 /var/lib/rstudio-server
